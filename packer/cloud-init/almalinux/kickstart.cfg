# AlmaLinux 10 Kickstart Configuration
# Automated installation with custom partitioning

# System language
lang en_US.UTF-8

# Keyboard layout
keyboard --vckeymap=cz --xlayouts='cz'

# System timezone
timezone ${vm_timezone} --utc

# Network configuration
network --bootproto=static --ip=${vm_ip_address} --netmask=255.255.255.0 --gateway=${vm_gateway} --nameserver=${vm_dns_primary},${vm_dns_secondary} --hostname=${vm_hostname} --device=eth0 --activate

# Root password (will be locked)
rootpw --lock

# Create admin user
user --name=${vm_admin_user} --groups=wheel --password=${vm_admin_password_hash} --iscrypted --gecos="System Administrator"

# SELinux configuration
selinux --enforcing

# Firewall configuration
firewall --enabled --ssh

# System services
services --enabled=sshd,qemu-guest-agent,cloud-init

# Installation method
url --url=https://repo.almalinux.org/almalinux/10/BaseOS/x86_64/os/

# Disk partitioning
zerombr
clearpart --all --initlabel
bootloader --location=mbr --append="crashkernel=auto"
autopart --type=plain --nohome

# Package selection
%packages --ignoremissing
@core
openssh-server
qemu-guest-agent
cloud-init
cloud-utils-growpart
python3
sudo
-iwl*firmware
-aic94xx-firmware
-alsa-firmware
-ivtv-firmware
%end

# Post-installation script
%post --log=/root/ks-post.log

# Configure sudo for admin user
echo "${vm_admin_user} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${vm_admin_user}
chmod 440 /etc/sudoers.d/${vm_admin_user}

# Configure SSH
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config

# Add SSH public key for admin user
mkdir -p /home/${vm_admin_user}/.ssh
chmod 700 /home/${vm_admin_user}/.ssh
echo "${vm_ssh_public_key}" > /home/${vm_admin_user}/.ssh/authorized_keys
chmod 600 /home/${vm_admin_user}/.ssh/authorized_keys
chown -R ${vm_admin_user}:${vm_admin_user} /home/${vm_admin_user}/.ssh

# Configure cloud-init
cat > /etc/cloud/cloud.cfg.d/99_custom.cfg <<EOF
datasource_list: [ ConfigDrive, NoCloud, None ]
disable_root: true
ssh_pwauth: false
preserve_hostname: false
manage_etc_hosts: true
EOF

# Enable services
systemctl enable sshd
systemctl enable qemu-guest-agent
systemctl enable cloud-init

# Update system
dnf update -y

%end

# Reboot after installation
reboot --eject
