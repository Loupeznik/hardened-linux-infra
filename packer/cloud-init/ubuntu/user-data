#cloud-config
autoinstall:
  version: 1
  locale: en_US.UTF-8
  keyboard:
    layout: cz

  network:
    version: 2
    ethernets:
      any:
        match:
          name: "en*"
        dhcp4: false
        addresses:
          - ${vm_ip_address}/${vm_network_prefix}
        routes:
          - to: default
            via: ${vm_gateway}
        nameservers:
          addresses:
            - ${vm_dns_primary}
            - ${vm_dns_secondary}
          search:
            - ${vm_dns_domain}

  storage:
    layout:
      name: custom
    config:
      - type: disk
        id: disk0
        ptable: gpt
        wipe: superblock
        grub_device: true

      - type: partition
        id: boot-partition
        device: disk0
        size: 1G
        flag: boot

      - type: format
        id: boot-fs
        volume: boot-partition
        fstype: ext4

      - type: mount
        id: boot-mount
        device: boot-fs
        path: /boot

      - type: partition
        id: root-partition
        device: disk0
        size: 20G

      - type: format
        id: root-fs
        volume: root-partition
        fstype: ext4

      - type: mount
        id: root-mount
        device: root-fs
        path: /

      - type: partition
        id: tmp-partition
        device: disk0
        size: 5G

      - type: format
        id: tmp-fs
        volume: tmp-partition
        fstype: ext4

      - type: mount
        id: tmp-mount
        device: tmp-fs
        path: /tmp
        options: nodev,nosuid,noexec

      - type: partition
        id: var-partition
        device: disk0
        size: 20G

      - type: format
        id: var-fs
        volume: var-partition
        fstype: ext4

      - type: mount
        id: var-mount
        device: var-fs
        path: /var
        options: nodev

      - type: partition
        id: var-log-partition
        device: disk0
        size: 10G

      - type: format
        id: var-log-fs
        volume: var-log-partition
        fstype: ext4

      - type: mount
        id: var-log-mount
        device: var-log-fs
        path: /var/log
        options: nodev,nosuid,noexec

      - type: partition
        id: home-partition
        device: disk0
        size: 10G

      - type: format
        id: home-fs
        volume: home-partition
        fstype: ext4

      - type: mount
        id: home-mount
        device: home-fs
        path: /home
        options: nodev,nosuid

      - type: partition
        id: swap-partition
        device: disk0
        size: 4G

      - type: format
        id: swap-fs
        volume: swap-partition
        fstype: swap

      - type: mount
        id: swap-mount
        device: swap-fs
        path: none

  identity:
    hostname: ${vm_hostname}
    username: ${vm_admin_user}
    password: ${vm_admin_password_hash}

  ssh:
    install-server: true
    allow-pw: false
    authorized-keys:
      - ${vm_ssh_public_key}

  packages:
    - openssh-server
    - qemu-guest-agent
    - cloud-init
    - python3
    - sudo

  user-data:
    timezone: ${vm_timezone}
    preserve_hostname: false
    manage_etc_hosts: true

    users:
      - name: ${vm_admin_user}
        gecos: System Administrator
        shell: /bin/bash
        groups: [adm, cdrom, dip, plugdev, sudo]
        lock_passwd: false
        sudo: ALL=(ALL) NOPASSWD:ALL
        ssh_authorized_keys:
          - ${vm_ssh_public_key}

    runcmd:
      - systemctl enable qemu-guest-agent
      - systemctl start qemu-guest-agent
      - apt-get update
      - apt-get upgrade -y
      - timedatectl set-timezone ${vm_timezone}
      - hostnamectl set-hostname ${vm_hostname}
      - sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
      - systemctl restart sshd

  late-commands:
    - echo '${vm_admin_user} ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/${vm_admin_user}
    - chmod 440 /target/etc/sudoers.d/${vm_admin_user}
    - curtin in-target --target=/target -- systemctl enable qemu-guest-agent
    - curtin in-target --target=/target -- systemctl enable ssh
